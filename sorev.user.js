// ==UserScript==
// @name         Соревнования
// @version      12.03.21
// @description  Запись на соревнования. ПРИ ВЫПОЛНЕНИИ НЕ СИДИТЕ НА СТРАНИЦЕБ ОТ ЭТОГО СКРИПТ ТОРМОЗИТ! И НЕ ЗАХОДИТЕ К ДРУГИМ ЛОШАДЯМ!
// @namespace    http://tampermonkey.net/
// @author       4eDo
// @match        https://www.lowadi.com/elevage/chevaux/*
// @match        https://www.lowadi.com/elevage/competition/*
// ==/UserScript==
if($("body#global").append('<div class="stopMe" style="display:block;color:#ffffff;position:fixed;width: 100px;height: 20px;top: 30px;padding: 5px;left: 10px;background-color:rgba(128, 0, 0, 0.9);z-index:990;border-radius: 4px;"><center><button id="noCup" type="button"> ОСТАНОВИТЬ </button></center></div>'),$("#noCup").click(function(){localStorage.setItem("stopCup",0),localStorage.setItem("isOpt",0),document.title="П Р Е К Р А Щ А Ю",location.reload(),alert("Запись на соревнования прервана.")}),1==localStorage.getItem("isOpt")){var sorev=localStorage.getItem("inpSorev"),selYY=localStorage.getItem("inpYY"),selMM=localStorage.getItem("inpMM"),doLesson=localStorage.getItem("inpLesson"),difficulty=localStorage.getItem("inpMinDiff"),compAll=localStorage.getItem("inpType"),maxAge=0,hrsEnrg=0;maxAge=parseInt(parseInt(localStorage.getItem("startAge"))+parseInt(12*selYY)+parseInt(selMM))}else document.title="З А В Е Р Ш Е Н О",$("body#global").append('<div class="cupPanel" style="display:block;color:#ffffff;position:fixed;width: 400px;height: 200px;top: 50%;margin-top: -100px;margin-left: -200px;padding: 20px;left: 50%;background-color:rgba(0, 0, 0, 0.9);z-index:990;border-radius: 4px;"></div>'),$(".cupPanel").append('<center><p style="z-index:999;color:#ffffff; font-size: 13px; font-family: Arial,Helvetica,sans-serif;text-shadow: 1px 1px 2px #778899;margin-top:5px;"><b>Настройки</b></p></center></br>'),$(".cupPanel").append('<p>Сколько записывать: <input id="inpYY" type="number" min="0" value="0">лет  <input id="inpMM" type="number" min="0" value="0">мес. </p>'),$(".cupPanel").append('<p>Соревнование: <select id="inpSorev" style=" "><option value="Рысь">Рысь</option><option value="Галоп">Галоп</option><option value="Выездка">Выездка</option><option value="Кросс">Кросс</option><option value="Конкур">Конкур</option><option value="Гонки вокруг бочек">Гонки вокруг бочек</option><option value="Каттинг">Каттинг</option><option value="Трейл">Трейл</option><option value="Рейнинг">Рейнинг</option><option value="Вестерн плеже">Вестерн плеже</option></select></p>'),$(".cupPanel").append('<p>Мин. сложность: <input id="inpMinDiff" type="number" min="0" max="100" step="0.01" value="0">% </p>'),$(".cupPanel").append('<p>Соревнования: <select id="inpType" style=" "><option value="1">Все</option><option value="0">Только породные</option> (лучше не менять)</select></p>'),$(".cupPanel").append('<p>Урок: <select id="inpLesson" style=" "><option value="1">Включён</option><option value="0">Выключен</option></select></p>'),$(".cupPanel").append('</br><center><button id="submCup" type="button"> Применить и запустить </button></center>');null!==localStorage.getItem("isOpt")?($("#inpYY").val(localStorage.getItem("inpYY")),$("#inpMM").val(localStorage.getItem("inpMM")),$("#inpMinDiff").val(localStorage.getItem("inpMinDiff")),$("#inpSorev").val(localStorage.getItem("inpSorev")),$("#inpType").val(localStorage.getItem("inpType")),$("#inpLesson").val(localStorage.getItem("inpLesson"))):($("#inpYY").val(0),$("#inpMM").val(1),$("#inpMinDiff").val(0)),$("#submCup").click(function(){localStorage.setItem("inpYY",$("#inpYY").val()),localStorage.setItem("inpMM",$("#inpMM").val()),localStorage.setItem("inpMinDiff",$("#inpMinDiff").val()),localStorage.setItem("inpSorev",$("#inpSorev option:selected").val()),localStorage.setItem("inpType",$("#inpType option:selected").val()),localStorage.setItem("inpLesson",$("#inpLesson option:selected").val()),localStorage.setItem("cupCount",0),localStorage.setItem("isOpt",1),-1!==location.href.indexOf("chevaux/cheval?id")&&localStorage.setItem("startAge",chevalAge),alert("Настройки применены. Нажмите 'Ок', чтобы запустить скрипт.\n\n Покиньте вкладку до завершения работы скрипта (он смущается и работает медленнее). Не заходите к другим лошадям. \n\n После завершения надпись на вкладке изменится на 'Завершено'."),location.reload()}),localStorage.setItem("stopCup",0);var tSleep,tEat,tRun,growButton=0,energy=20;function pause(e){return Math.floor(251*Math.random())+150+e}function getTime(){var e=$(".hour").text(),t=60*+(e[0]+e[1])+ +(e[3]+e[4]);return console.log("Смотрю время"),t}function clearNulls(){growButton=0}function getMerch(e){console.log("Смотрю, есть ли "+e);var t=0,o=$("#objects-body-content a");if(0!==o.length)for(var n=0;n<o.length;n++)-1!==$("#objects-body-content a").eq(n).attr("data-tooltip").indexOf(e)&&(t=1);return 0!==t}function lesson(){$("#mission-wrapper a").click(),console.log("Выполняю урок")}function drink(){$("#boutonBoire").click(),console.log("Пою лошадь")}function carrot(){$("#boutonCarotte").click(),console.log("Угощаю морковкой")}function care(){$("#boutonCaresser").click(),console.log("Глажу лошадку =)")}function wash(){$("#boutonPanser").click(),console.log("Чищу")}function milk(){$("#boutonAllaiter").click(),console.log("Молочко лапочке")}function mash(){$("#boutonMash").click(),console.log("Смесь")}function feed(){if(console.log("Кормлю"),chevalAge>4){var e=$(".float-right.section-fourrage.section-fourrage-quantity").text().trim().split(" / "),t=+e[1],o=+e[0];if(-1!==$("#care-tab-feed #messageBoxInline").text().indexOf("недостаточный")&&(t=20-o),$("#haySlider li:eq("+(t-o)+")").click(),chevalAge>16){var n=$(".float-right.section-avoine.section-avoine-quantity").text().trim().split(" / "),a=+n[1],l=+n[0];$("#oatsSlider li:eq("+(a-l)+")").click()}setTimeout(function(){$("#feed-button").click()},200)}else milk()}function sleep(){console.log("Баю-бай, засыпай"),$("#boutonCoucher").click()}function grow(){0==growButton&&(console.log("Выращиваю"),$('#night-wrapper button:contains("Подтвердить")').click(),growButton=1)}function galop(){console.log("Идём на соревы"),$('a:contains("'+sorev+'")')[0].click()}function needWash(){return!$("#boutonPanser").hasClass("action-disabled")}function needDrink(){return!$("#boutonBoire").hasClass("action-disabled")&&!getMerch("Ласка Филотес")}function needCarrot(){return!$("#boutonCarotte").hasClass("action-disabled")&&!getMerch("Ласка Филотес")}function needCare(){return!$("#boutonCaresser").hasClass("action-disabled")}function needFeed(){var e=$(".float-right.section-fourrage.section-fourrage-quantity").text().trim().split(" / "),t=+e[1],o=+e[0],n=$(".float-right.section-avoine.section-avoine-quantity").text().trim().split(" / "),a=+n[1],l=+n[0];return chevalAge<6&&1==doMilk?!$("#boutonAllaiter").hasClass("action-disabled"):chevalAge>17?!(o>=t&&l>=a||-1!==$("#care-tab-feed #messageBoxInline").text().indexOf("толст")):!(chevalAge<6)&&!(o>=t||-1!==$("#care-tab-feed #messageBoxInline").text().indexOf("толст"))}function needLesson(){return chevalAge>23&&+$("#energie").text()-+$("#mission-wrapper").html().substr($("#mission-wrapper").html().indexOf("Энергия"),45).replace(/[^,0-9]/gim,"").replace(/[,]/gim,".")>20&&1==doLesson&&(-1===$("#mission").text().indexOf("недостаточно энергии")&&!$("#mission-wrapper a").hasClass("action-disabled"))}function needSleep(){return!$("#boutonCoucher").hasClass("action-disabled")}function needMash(){return!($("#boutonMash").hasClass("action-disabled")||chevalAge<24)}function laska(){needCare()?(document.title="Ласка",care()):needDrink()?(document.title="Пить",drink()):needCarrot()?(document.title="Морковь",carrot()):needMash()&&(document.title="Смесь",mash())}function needLaska(){return!!(needCare()||needCarrot()||needDrink())}function progon(){if(-1!==location.href.indexOf("chevaux/cheval?id"))document.title="Лошадь",getMerch("Ахиллесова пята")?(tSleep=1439,tEat=1409,tRun=1319):(tSleep=1319,tEat=1289,tRun=1169),chevalAge<maxAge?getTime()>=tSleep?needSleep()?(document.title="Спать",sleep()):(document.title="Ор",grow()):needFeed()&&getTime()>=tEat?(document.title="Корм",feed()):needWash()?(document.title="Чистка",wash()):needLesson()?(document.title="Урок",lesson()):+$("#energie").text()-energy>0&&getTime()<=tRun?(document.title="Соревнования",hrsEnrg=parseFloat($("#energie").text()),localStorage.setItem("hrsEnrg",hrsEnrg),galop()):needLaska()?laska():needFeed()?(document.title="Корм",feed()):needSleep()?(document.title="Сон",sleep()):(document.title="Ор",grow()):(clearTimeout(mainSet),clearTimeout(checkSet),localStorage.setItem("stopCup",0),localStorage.setItem("isOpt",0),document.title="З А В Е Р Ш Е Н О",location.reload(),alert("Запись на соревнования окончена. \n Для продолжения работы нажмите 'Ок'"));else if(-1!==location.href.indexOf("competition/inscription"))if(document.title="запись...",0!==$("#race").length||0!==$("#public").length){var e=0,t=0,o=0,n=$('#race tr[height="40"] td[class^="width-10 align-center"] .nowrap');if(+$('#race tr[height="40"]:eq(0) td[class^="width-10 align-center"] .nowrap').eq(a).text().replace(/[^.0-9]/gim,"")>difficulty)for(var a=0;a<n.length;a++)t=+$('#race tr[height="40"]:eq(0) td[class^="width-10 align-center"] .nowrap').eq(a).text().replace(/[^.0-9]/gim,""),o=parseFloat($('#race tr[height="40"]:eq(0) td[class^="width-20 align-center"] strong').eq(a).text()),hrsEnrg=parseFloat(localStorage.getItem("hrsEnrg")),t>=difficulty&&hrsEnrg-o>0&&(hrsEnrg=parseFloat(localStorage.getItem("hrsEnrg"))-o,localStorage.setItem("hrsEnrg",hrsEnrg),$('#race tr[height="40"]:eq('+a+') td[class^="width-10 align-center"] button').click(),e=parseInt(localStorage.getItem("cupCount")),e++,localStorage.setItem("cupCount",e)),hrsEnrg-o<1&&$("#table-0 a.horsename")[0].click();else if(1==compAll){n=$('#public tr[height="40"] td[class^="width-10 align-center"] button');for(var l=0;l<n.length;l++)t=+$('#public tr[height="40"]:eq(0) td[class^="width-10 align-center"] .nowrap ').eq(l).text().replace(/[^.0-9]/gim,""),o=parseFloat($('#public tr[height="40"]:eq(0) td[class^="width-20 align-center"] strong').eq(l).text()),hrsEnrg=parseFloat(localStorage.getItem("hrsEnrg")),t>=difficulty&&hrsEnrg-o>0&&(hrsEnrg=parseFloat(localStorage.getItem("hrsEnrg"))-o,localStorage.setItem("hrsEnrg",hrsEnrg),$('#public tr[height="40"]:eq('+l+') td[class^="width-10 align-center"] button').click(),e=parseInt(localStorage.getItem("cupCount")),e++,localStorage.setItem("cupCount",e)),hrsEnrg-o<1&&$("#table-0 a.horsename")[0].click()}else 0===compAll&&(alert("Соревнований, удовлетворяющих заданным критериям, нет. Попробуйте повторить позже. \n Для продолжения работы нажмите 'Ок'"),clearTimeout(mainSet),clearTimeout(checkSet),localStorage.setItem("stopCup",1))}else-1!==document.body.innerHTML.indexOf("доступных состязаний нет.")&&0===growButton&&($("#table-0 a.horsename")[0].click(),growButton=1);else-1!==location.href.indexOf("/elevage/chevaux/?elevage=")&&(history.go(-1),pause(6e5))}if(1==localStorage.getItem("isOpt"))var checkSet=setTimeout(function e(){clearNulls(),setTimeout(e,pause(7850))},pause(7850)),mainSet=setTimeout(function e(){0==localStorage.getItem("stopCup")&&progon(),setTimeout(e,pause(0))},pause(0));
